@using BCKFreightTMS.Common.Enums
@model BCKFreightTMS.Web.ViewModels.Orders.OrderFinishViewModel
@{ 
    var documentation = Model.OrderStatus.Documentation;
}
<div asp-validation-summary="ModelOnly" class="text-danger"></div>
<h4><b>Documentation check</b></h4>
<hr />
<form method="post" class="p-2" id="documentation_form">
    <div class="form-row">
        <div class="form-group border border-dark rounded bg-gray-light p-2">
            <h5 class="text-muted text-bold ml-2">Requaired documentation</h5>
            <div class="col" id="reqDoc">
                @if (@documentation.CMR)
                {<div><i class="fas fa-check"></i><label>&nbsp;CMR</label></div>}
                @if (@documentation.BillOfLading)
                {<div><i class="fas fa-check"></i><label>&nbsp;Bill of lading</label></div>}
                @if (@documentation.AOA)
                {<div><i class="fas fa-check"></i><label>&nbsp;Act of acceptance</label></div>}
                @if (@documentation.DeliveryNote)
                {<div><i class="fas fa-check"></i><label>&nbsp;Delivery note</label></div>}
                @if (@documentation.PackingList)
                {<div><i class="fas fa-check"></i><label>&nbsp;Packing list</label></div>}
                @if (@documentation.ListItems)
                {<div><i class="fas fa-check"></i><label>&nbsp;List items</label></div>}
                @if (@documentation.Invoice)
                {<div><i class="fas fa-check"></i><label>&nbsp;Invoice</label></div>}
                @if (@documentation.BillOfGoods)
                {<div><i class="fas fa-check"></i><label>&nbsp;Bill of goods</label></div>}
            </div>
        </div>
        <div class="form-group border border-dark rounded bg-gray-light p-2 ml-2">
            <h5 class="text-muted text-bold ml-2">Recieved documentation</h5>
            <div class="col">
                <div><input asp-for="RecievedDocumentation.CMR" type="checkbox"><label>&nbsp;CMR</label></div>
                <div><input asp-for="RecievedDocumentation.BillOfLading" type="checkbox"><label>&nbsp;Bill of lading</label></div>
                <div><input asp-for="RecievedDocumentation.AOA" type="checkbox"><label>&nbsp;Act of acceptance</label></div>
                <div><input asp-for="RecievedDocumentation.DeliveryNote" type="checkbox"><label>&nbsp;Delivery note</label></div>
                <div><input asp-for="RecievedDocumentation.PackingList" type="checkbox"><label>&nbsp;Packing list</label></div>
                <div><input asp-for="RecievedDocumentation.ListItems" type="checkbox"><label>&nbsp;List items</label></div>
                <div><input asp-for="RecievedDocumentation.Invoice" type="checkbox"><label>&nbsp;Invoice</label></div>
                <div><input asp-for="RecievedDocumentation.BillOfGoods" type="checkbox"><label>&nbsp;Bill of goods</label></div>
            </div>
        </div>
    </div>
    @Html.HiddenFor(m => m.OrderStatus.Documentation.CMR)
    @Html.HiddenFor(m => m.OrderStatus.Documentation.BillOfLading)
    @Html.HiddenFor(m => m.OrderStatus.Documentation.AOA)
    @Html.HiddenFor(m => m.OrderStatus.Documentation.DeliveryNote)
    @Html.HiddenFor(m => m.OrderStatus.Documentation.PackingList)
    @Html.HiddenFor(m => m.OrderStatus.Documentation.ListItems)
    @Html.HiddenFor(m => m.OrderStatus.Documentation.Invoice)
    @Html.HiddenFor(m => m.OrderStatus.Documentation.BillOfGoods)
    @Html.HiddenFor(m => m.OrderStatus.Id)
    @Html.HiddenFor(m => m.OrderStatus.StatusName)

    <div class="form-group">
        @if (Model.OrderStatus.StatusName != OrderStatusNames.Approved.ToString())
        {
            <a onclick="CheckDoc()" class="btn btn-success text-white @(Model.OrderStatus.StatusName == OrderStatusNames.AwaitingApproval.ToString()?"disabled":null)" value="Finish">Finish</a>
            <div class="modal" id="modal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Warning</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p class="text-bold text-center">
                                The requaired documentation do not match the received documentation!
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-warning" asp-action="FinishOrder">Mark for approval</button>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <input asp-action="FinishOrder" type="submit" class="btn btn-success" value="Approved" />
        }
        @if (Model.OrderStatus.StatusName == OrderStatusNames.AwaitingApproval.ToString())
        {
            <input asp-action="ApproveDocumentation" type="submit" class="btn btn-warning" value="Approve order documentation" />
        }
        <a asp-action="Index" class="btn btn-secondary">Cancel</a>
    </div>
</form>
@section Scripts{
    <script>
        function CheckDoc() {
            let reqDoc = $("#reqDoc label").map(function () { return this.textContent });
            if ($(':checkbox:checked').length != reqDoc.length) {
                $('#modal').modal('show');
                return;
            }
            $(':checkbox:checked').map(function () { return this.nextSibling }).each(function () {
                if (jQuery.inArray(this.textContent, reqDoc) == -1) {
                    $('#modal').modal('show');
                    return;
                }
            })
            let form = document.getElementById("documentation_form");
            form.action = "/Orders/FinishOrder";
            form.submit();
        }
    </script>
}